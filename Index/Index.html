<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Salu Plus | Gesti√≥n de Laboratorio</title>
  
  <script src="https://cdn.tailwindcss.com"></script>
  
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            salu: {
              900: '#1e3a8a', // Azul profundo
              800: '#1e40af',
              50: '#f9fafb',
            }
          }
        }
      }
    }
  </script>

  <style>
    /* Estilos adicionales para tablas generadas din√°micamente */
    table { width: 100%; border-collapse: collapse; margin-top: 1rem; font-size: 0.875rem; }
    th { background-color: #f3f4f6; color: #1f2937; font-weight: 600; padding: 0.75rem; text-align: left; border-bottom: 2px solid #e5e7eb; }
    td { padding: 0.75rem; border-bottom: 1px solid #e5e7eb; color: #4b5563; }
    tr:hover { background-color: #f9fafb; }
    
    /* Animaci√≥n suave para inputs */
    .input-transition { transition: all 0.2s ease-in-out; }
	
	
	
  </style>
</head>
<body class="bg-gray-50 text-gray-700 font-sans antialiased min-h-screen flex flex-col">

  <header class="bg-white shadow-sm border-b border-gray-200">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 h-20 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="w-10 h-10 bg-salu-900 rounded-lg flex items-center justify-center text-white font-bold text-xl">
          S+
        </div>
        <div>
          <h1 class="text-2xl font-bold text-gray-900 tracking-tight">Salu Plus</h1>
          <p class="text-xs text-gray-500 uppercase tracking-wide">Excelencia en Laboratorio</p>
        </div>
      </div>
      <div id="authArea" class="text-sm"></div>
    </div>
  </header>

  <main class="flex-grow py-10 px-4 sm:px-6 lg:px-8">
    <div class="max-w-5xl mx-auto">
      
      <div class="mb-8 text-center max-w-2xl mx-auto">
        <h2 class="text-3xl font-semibold text-gray-900 mb-3">Gesti√≥n de An√°lisis Cl√≠nicos</h2>
        <p class="text-gray-600 leading-relaxed">
          Procesamiento de datos con los est√°ndares de calidad, precisi√≥n y seguridad que caracterizan a SUsa credenciales para obtener token. (El token no se mostrar√°)alu Plus.
        </p>
      </div>

      <div class="bg-white shadow-lg rounded-xl border border-gray-200 overflow-hidden">
        
        <div class="bg-gray-50 px-6 py-4 border-b border-gray-200 flex justify-between items-center">
          <h3 class="text-lg font-medium text-gray-800">Importar TXT de Laboratorio</h3>
          <span class="badge bg-blue-100 text-salu-900 text-xs px-2 py-1 rounded-full font-semibold" id="countBadge">0 filas</span>
        </div>

        <div class="p-6 space-y-6">
          
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="space-y-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Cargar archivo .txt</label>
                <input id="file" type="file" accept=".txt" 
                  class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-salu-900 hover:file:bg-blue-100 cursor-pointer border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-salu-900 focus:border-transparent input-transition">
              </div>

              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Pegar contenido manual</label>
                <textarea id="input" rows="6" placeholder="Pegue aqu√≠ el texto crudo del laboratorio..." 
                  class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-salu-900 focus:border-transparent outline-none text-sm font-mono text-gray-600 input-transition resize-none"></textarea>
              </div>
            </div>

            <div class="flex flex-col justify-between space-y-4">
              
              <div class="grid grid-cols-2 gap-3">
                <button id="parse" class="col-span-2 bg-salu-900 text-white py-2 px-4 rounded-lg hover:bg-blue-800 transition font-medium shadow-md flex items-center justify-center gap-2">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                  Parsear Datos
                </button>
                <button id="clear" class="border border-gray-300 text-gray-700 py-2 px-4 rounded-lg hover:bg-gray-50 transition text-sm">
                  Limpiar
                </button>
				
				<!-- PROGRESO DE SUBIDA -->
<div id="uploadProgress" class="hidden mt-6">
  <div class="flex justify-between mb-1 text-sm">
    <span class="font-medium text-salu-900">
      Subiendo resultados a la API‚Ä¶
    </span>
    <span id="progressText" class="text-gray-600">
      0 / 0
    </span>
  </div>

  <div class="w-full bg-gray-200 rounded-full h-3 overflow-hidden">
    <div id="progressBar"
      class="bg-salu-900 h-3 rounded-full transition-all duration-300"
      style="width: 0%">
    </div>
  </div>

  <div class="mt-2 text-xs text-gray-500">
    ‚úî <span id="okCount">0</span> √©xitos ¬∑
    ‚ùå <span id="failCount">0</span> errores
  </div>
</div>
              </div>

              <div class="bg-gray-50 p-4 rounded-lg border border-gray-200 space-y-3">
                <label class="block text-xs font-semibold text-gray-500 uppercase">Filtros de Visualizaci√≥n</label>
                <input id="filterInput" placeholder="Buscar por paciente, prueba o ID..." 
                  class="w-full p-2 border border-gray-300 rounded focus:ring-1 focus:ring-salu-900 outline-none text-sm">
                
                <div class="flex items-center">
                  <input id="mappedOnly" type="checkbox" class="h-4 w-4 text-salu-900 border-gray-300 rounded focus:ring-salu-900">
                  <label for="mappedOnly" class="ml-2 block text-sm text-gray-700">Solo con ID asignado</label>
                </div>
              </div>

            </div>
          </div>
          
          <hr class="border-gray-100">

          <div class="flex items-center gap-4 bg-blue-50 p-4 rounded-lg border border-blue-100">
            <div class="flex-grow">
              <label class="block text-xs font-bold text-salu-900 mb-1">ID DE USUARIO (API)</label>
              <input id="idUsuario" type="number" placeholder="Ej: 12345" disabled 
                class="w-full bg-white border border-blue-200 text-gray-600 text-sm rounded p-2 opacity-70 cursor-not-allowed">
            </div>
            <button id="sendApi" class="mt-4 bg-white border border-blue-300 text-salu-900 font-medium py-2 px-6 rounded-lg hover:bg-blue-100 transition shadow-sm whitespace-nowrap">
              Subir a API ArmarJson
            </button>
          </div>

        </div>
      </div>

      <div id="resultArea" class="mt-8 bg-white shadow-lg rounded-xl border border-gray-200 overflow-x-auto min-h-[100px] p-1">
        <p class="text-center text-gray-400 py-10 italic">Los resultados procesados aparecer√°n aqu√≠.</p>
      </div>

    </div>
  </main>

  <footer class="bg-white border-t border-gray-200 mt-auto">
    <div class="max-w-7xl mx-auto py-6 px-4 sm:px-6 lg:px-8 flex flex-col md:flex-row justify-between items-center gap-4">
      <p class="text-sm text-gray-500">
        &copy; 2025 Salu Plus Laboratorio. Confianza que se analiza.
      </p>
      <div class="text-xs text-gray-400 bg-gray-50 px-3 py-1 rounded border border-gray-100">
        <span class="font-semibold">Seguridad:</span> El token de sesi√≥n se gestiona internamente y no es visible.
      </div>
    </div>
  </footer>

  <script >

/* ====== Config ====== */
const API_BASE = "https://laboratorio-psi-mauve.vercel.app/-RB-/sURBIR";
const LOGIN_URL = "https://api.saludplus.co/api/auth/Login";

const EXAM_MAP = {
  "GLUCOSE": "11803", "GLUCOSA": "11803",
  "CHOLESTEROL": "9096", "COL": "9096",
  "TRIGLYCERIDES": "9146", "TRIGLICERIDOS": "9146",
  "LDL": "9094", "COLESTEROL LDL": "9094",
  "CREATININE": "9173", "CREATININA": "9173",
  "BUN": "9134", "UREA": "9147",
  "URIC ACID": "9079", "ACIDO URICO": "9079",
  "BILIRUBIN DIRECT": "9087",
  "BILIRUBIN INDIRECT": "9087", "INDIRECT BILIRUBIN": "9087","INDIRECT BILURB": "9087",
  "BILIRUBIN TOTAL": "9087", "BILIRRUBINA TOTAL": "9087",
  "CHOL HDL DIRECT": "9093", "HDL": "9093",
  "CHOL LDL DIRECT": "9094"
};
const CURVA_PREFIX = /^(PRE|POST|1[/]?2H?|1H|2H|3H|B)$/i;
function normalize(s){return (s||"").toString().trim().toUpperCase();}

/* ====== Extraer solo el mensaje ====== */
function extractMessageFromResponse(text) {
  try {
    // Intenta parsear como JSON
    const json = JSON.parse(text);
    
    // Busca el campo "mensaje" en diferentes niveles
    if (json.mensaje) return json.mensaje;
    
    // Si no, busca en respuestaSaludPlus
    if (json.respuestaSaludPlus && json.respuestaSaludPlus.mensaje) {
      return json.respuestaSaludPlus.mensaje;
    }
    
    // Si hay success y alg√∫n mensaje
    if (json.success && json.respuestaSaludPlus) {
      return "Env√≠o exitoso";
    }
    
    // Si no encuentra mensaje, devuelve el texto completo pero truncado
    return text.length > 100 ? text.substring(0, 100) + "..." : text;
  } catch (e) {
    // Si no es JSON v√°lido, busca el patr√≥n "mensaje": en el texto
    const mensajeMatch = text.match(/"mensaje"\s*:\s*"([^"]+)"/);
    if (mensajeMatch && mensajeMatch[1]) {
      return mensajeMatch[1];
    }
    
    // Si no encuentra, devuelve texto truncado
    return text.length > 100 ? text.substring(0, 100) + "..." : text;
  }
}

/* ====== Token / Usuario ====== */
let _TOKEN = null;
let _USER = null;



function renderAuth() {
  const el = document.getElementById('authArea');
  el.innerHTML = '';

  /* ================= LOGIN ================= */
  if (!_USER) {
    el.innerHTML = `
      <div class="flex items-center gap-2
                  bg-gray-100 border border-gray-300
                  rounded-full px-2 py-1 shadow-sm">

        <input id="loginUser"
          class="bg-transparent text-gray-700
                 placeholder-gray-400 text-sm
                 px-3 py-1 w-32
                 focus:outline-none"
          type="text" placeholder="Usuario">

        <div class="w-px h-5 bg-gray-300"></div>

        <input id="loginPass"
          class="bg-transparent text-gray-700
                 placeholder-gray-400 text-sm
                 px-3 py-1 w-32
                 focus:outline-none"
          type="password" placeholder="Contrase√±a">

        <button id="btnLogin"
          class="flex items-center gap-1
                 bg-salu-900 hover:bg-salu-800
                 text-white font-semibold
                 text-sm px-4 py-1.5 rounded-full
                 transition active:scale-95">
          üîê Entrar
        </button>
      </div>
    `;

    document.getElementById('btnLogin')
      .addEventListener('click', doLogin);

  /* ================= USER ================= */
  } else {
    const initials =
      _USER.iniciales ||
      (_USER.nombre || _USER.usuario || '?')
        .split(' ')
        .map(x => x[0])
        .slice(0, 2)
        .join('');

    el.innerHTML = `
      <div class="flex items-center gap-3
                  bg-gray-100 border border-gray-300
                  rounded-full px-3 py-1.5 shadow-sm">

        <div class="w-9 h-9 rounded-full
                    bg-salu-900 text-white
                    flex items-center justify-center
                    font-bold text-sm">
          ${initials}
        </div>

        <div class="leading-tight">
          <div class="text-sm font-semibold text-gray-900">
            ${escapeHtml(_USER.nombre || _USER.usuario)}
          </div>
          <div class="text-xs text-gray-500">
            ID ${_USER.id ?? '-'} ¬∑ ${_USER.isAdmin ? 'ADMIN' : 'USUARIO'}
          </div>
        </div>

        <button id="btnLogout"
          class="ml-2 text-xs text-red-600
                 hover:text-red-700
                 border border-red-300
                 px-3 py-1 rounded-full
                 transition">
          Salir
        </button>
      </div>
    `;

    document.getElementById('btnLogout')
      .addEventListener('click', () => {
        _TOKEN = null;
        _USER = null;
        renderAuth();
      });
  }
}



async function doLogin() {
  const user = document.getElementById('loginUser').value.trim();
  const pass = document.getElementById('loginPass').value.trim();
  if(!user || !pass) return alert('Usuario y password requeridos');
  try {
    const res = await fetch(LOGIN_URL, {
      method: 'POST', headers: {'Content-Type':'application/json'},
      body: JSON.stringify({username: user, password: pass})
    });
    if(!res.ok) {
      const txt = await res.text();
      console.error('Login failed', txt);
      return alert('Error de login: ' + (txt || res.status));
    }
    const data = await res.json();
    _TOKEN = data.token || data.accessToken || null;
    _USER = {
      id: data.id ?? null,
      nombre: data.nombre ?? data.displayName ?? data.usuario ?? null,
      usuario: data.usuario ?? data.username ?? null,
      estado: data.estado ?? true,
      isAdmin: data.isAdmin ?? false,
      iniciales: data.iniciales ?? null,
      perfiles: data.perfiles ?? []
    };
    const idInput = document.getElementById('idUsuario');
    if (idInput && _USER.id) idInput.value = _USER.id;
    renderAuth();
    alert('Login correcto. Ahora puedes enviar resultados a ArmarJson.');
  } catch (err) {
    console.error('Login error', err);
    alert('Error de red durante login');
  }
}

function escapeHtml(s){ return String(s||'').replace(/[&<>\\"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','\\':'\\\\','"':'&quot;',"'":"&#39;"})[c]); }

/* ====== Parsing ====== */
const dateRe = /^\d{1,2}\/\d{1,2}\/\d{4}$/;
const timeRe = /^\d{1,2}:\d{2}$/;
const numRe = /^\d+[\.,]?\d*$/;
const cmpNumRe = /^[<>]=?\d+[\.,]?\d*$/;
const dashSlashRe = /^[-\/]{2,}$/;
const resultWordsRe = /^(NEGATIVO|POSITIVO|REACTIVO|NO|TRAZAS|N\/A|INDETERMINADO)$/i;
const unitRe = /^(mg\/?d?l|mg|mmol\/l|mmol|g\/dl|g|iu\/l|iu|%|u\/l|ml|mL|ug\/mL|mg\/L)$/i;
function looksLikeResult(token, nextToken) {
  if (!token) return false;
  if (numRe.test(token)) return true;
  if (cmpNumRe.test(token)) return true;
  if (dashSlashRe.test(token)) return true;
  if (resultWordsRe.test(token)) return true;
  if (unitRe.test(nextToken)) return true;
  if (dateRe.test(nextToken) || timeRe.test(nextToken)) return true;
  if (/^[\d\-\+\/]+$/.test(token)) return true;
  return false;
}

function parseText(text) {
  const rows = [];
  const lines = text.replace(/\r/g, "").split('\n');
  for (let raw of lines) {
    raw = raw.trim();
    if (!raw) continue;
    if (!/^\d{5,7}/.test(raw)) continue;
    const parts = raw.split(/\s+/).filter(Boolean);
    if (parts.length < 3) continue;
    let idx = 0;
    const paciente = parts[idx++];
    let tipo = "-";
    if (idx < parts.length && CURVA_PREFIX.test(parts[idx])) { tipo = parts[idx].toUpperCase(); if (tipo === "1/2") tipo = "1/2H"; idx++; }
    let tecnica = "SER";
    if (idx < parts.length && ["SER","PLASMA","ORINA","SUERO","HECES"].includes(normalize(parts[idx]))) { tecnica = parts[idx]; idx++; }
    let pruebaParts = [];
    let conc = "";
    let unidades = "mg/dL";
    while (idx < parts.length) {
      const word = parts[idx];
      const next = parts[idx+1] || "";
      if (dateRe.test(word)) { pruebaParts.push(word); idx++; continue; }
      if (looksLikeResult(word, next)) { conc = word.replace(',', '.').trim(); idx++; break; }
      pruebaParts.push(word); idx++;
    }
    const prueba = pruebaParts.join(" ").trim();
    if (idx < parts.length && unitRe.test(parts[idx])) { unidades = parts[idx]; idx++; }
    else if (idx < parts.length && /mg|mmol|g\/dl|iu|%|ug/i.test(parts[idx])) { unidades = parts[idx]; idx++; }
    let fecha = "";
    if (idx < parts.length && dateRe.test(parts[idx])) { fecha = parts[idx]; if (idx+1 < parts.length && timeRe.test(parts[idx+1])) fecha += ' ' + parts[idx+1]; }
    if (!/^[-\/\s]+$/.test(conc)) {
      const rawConc = (conc||'').toString().trim();
      const comparatorMatch = rawConc.match(/^([<>]=?)([\d\.]+)$/);
      if (comparatorMatch) {
        const comp = comparatorMatch[1]; const num = Number(comparatorMatch[2].replace(',', '.'));
        if (!isNaN(num)) { const rounded=(Math.round(num*10)/10).toFixed(1); conc = `${comp}${rounded}` } else conc = rawConc;
      } else if (/^[+-]?\d+(\.\d+)?$/.test(rawConc)) {
        const n = Number(rawConc);
        if (!isNaN(n)) {
          conc = Number.isInteger(n)
            ? String(n)
            : (Math.round(n * 10) / 10).toFixed(1);
        } else {
          conc = rawConc;
        }
      }
    }
    let id_examen = "";
    const pruebaNorm = normalize(prueba);
    if (pruebaNorm.includes("GLUCOS") || pruebaNorm.includes("GLUCOSE")) {
      if (tipo === "PRE" || tipo === "POST") id_examen = "9121";
      else if (["1/2H","1H","2H","3H","B"].includes(tipo)) id_examen = "9122";
      else id_examen = "11803";
    } else {
      for (const key in EXAM_MAP) if (pruebaNorm.includes(normalize(key))) { id_examen = EXAM_MAP[key]; break; }
    }
    rows.push({ 
      paciente, 
      tipo, 
      tecnica, 
      prueba, 
      id_examen: id_examen || "", 
      conc, 
      unidades, 
      fecha: fecha || "", 
      apiMessage: '', 
      rowClass: 'row-pending'
    });
  }
  return rows;
}

/* ====== Render ====== */
let lastRows = [];

function render(rows){
  const filter = normalize(document.getElementById('filterInput').value);
  const onlyMapped = document.getElementById('mappedOnly').checked;
  let visible = 0;
  
  let html = `<table><thead><tr>
    <th>Paciente</th><th>Tipo</th><th>T√©cnica</th><th>Prueba</th>
    <th>ID_EXAMEN</th><th>Conc.</th><th>Unidades</th><th>Fecha/Hora</th>
    <th>MENSAJE API</th>
  </tr></thead><tbody>`;
  
  for (const r of rows) {
    if (onlyMapped && !r.id_examen) continue;
    if (filter && !(r.paciente.includes(filter) || normalize(r.prueba).includes(filter) || (r.id_examen && r.id_examen.includes(filter)))) continue;
    visible++;
    
    // Determinar clase CSS para la fila
    let rowClass = r.rowClass || 'row-pending';
    
    // Determinar clase para el mensaje
    let msgClass = 'api-pending';
    if (rowClass === 'row-success') msgClass = 'api-success';
    else if (rowClass === 'row-error') msgClass = 'api-error';
    else if (rowClass === 'row-sending') msgClass = 'api-sending';
    
    // Estilo para ID_EXAMEN
    const idStyle = r.id_examen ? "background:#ecfdf5;color:#166534;font-weight:700" : "color:#ef4444";
    
    html += `<tr class="${rowClass}">
      <td><strong>${r.paciente}</strong></td>
      <td><strong>${r.tipo}</strong></td>
      <td>${r.tecnica}</td>
      <td>${escapeHtml(r.prueba)}</td>
      <td style="${idStyle}">${r.id_examen || '-'}</td>
      <td style="text-align:right">${r.conc}</td>
      <td>${r.unidades}</td>
      <td>${r.fecha}</td>
      <td class="api-message ${msgClass}">${escapeHtml(r.apiMessage || '')}</td>
    </tr>`;
  }
  
  html += `</tbody></table>`;
  document.getElementById('countBadge').textContent = visible + ' filas';
  document.getElementById('resultArea').innerHTML = html || "<p style='color:#666'>No se encontraron datos.</p>";
}

// Eventos
document.getElementById('file').addEventListener('change', async e=>{ 
  const file=e.target.files[0]; 
  if(!file) return; 
  const text=await file.text(); 
  document.getElementById('input').value=text; 
});

document.getElementById('parse').addEventListener('click', ()=>{ 
  const txt=document.getElementById('input').value.trim(); 
  if(!txt) return alert('Pega o carga un archivo primero'); 
  lastRows = parseText(txt); 
  render(lastRows); 
});

document.getElementById('clear').addEventListener('click', ()=>{ 
  document.getElementById('input').value=''; 
  lastRows=[]; 
  document.getElementById('resultArea').innerHTML=''; 
  document.getElementById('countBadge').textContent='0 filas';
});

document.getElementById('filterInput').addEventListener('input', ()=>render(lastRows)); 
document.getElementById('mappedOnly').addEventListener('change', ()=>render(lastRows));

/* ====== Build payloads ====== */
function buildApiPayloads(rows, idUsuario) {
  const grouped = new Map();
  for (let i = 0; i < rows.length; i++) { 
    const r = rows[i];
    if (!r.id_examen) continue;
    const key = `${r.paciente}|${r.id_examen}`;
    if (!grouped.has(key)) grouped.set(key, {rows: [], idProcedimientoObjetivo: r.id_examen, documento: r.paciente, indices: []});
    grouped.get(key).rows.push(r);
    grouped.get(key).indices.push(i);
  }

  const payloads = [];
  for (const [key, groupData] of grouped.entries()) {
    const { documento, idProcedimientoObjetivo, rows: group } = groupData;
    const examId = idProcedimientoObjetivo;
    let body = { idUsuario: Number(idUsuario) };

    if (examId === '9087') {
      const total = group.find(g=>/TOTAL/i.test(g.prueba));
      const directa = group.find(g=>/DIRECTA|DIRECT/i.test(g.prueba));
      const indirecta = group.find(g=>/INDIRECTA|INDIRECT|BILURB/i.test(g.prueba));
      const totalVal = (total && total.conc) ? total.conc : '0';
      const directaVal = (directa && directa.conc) ? directa.conc : '0';
      const indirectaVal = (indirecta && indirecta.conc) ? indirecta.conc : '0';
      body.resultadosArray = [totalVal, directaVal, indirectaVal];
    } else if (examId === '9121') {
      const pre = group.find(g=>g.tipo==='PRE');
      const post = group.find(g=>g.tipo==='POST');
      const preVal=(pre&&pre.conc)?pre.conc:'0';
      const postVal=(post&&post.conc)?post.conc:'0';
      body.resultadosArray = [preVal, postVal];
    } else if (examId === '9122') {
      const slots = [
        {label:'GLUCOSA 2 HORAS', tipo:'2H'}, {label:'GLUCOSA 3 HORAS', tipo:'3H'},
        {label:'GLUCOSA 1 HORA', tipo:'1H'}, {label:'GLUCOSA MEDIA HORA', tipo:'1/2H'},
        {label:'OBSERVACI√ìN', tipo:null}, {label:'GLUCOSA BASAL', tipo:'B'}
      ];
      const resultadosArray = slots.map(slot=>{
        if(!slot.tipo) return '0';
        const row = group.find(g=>g.tipo===slot.tipo);
        return (row&&row.conc)?row.conc:'0';
      });
      body.resultadosArray = resultadosArray;
    } else {
      const first = group[0];
      const val = (first&&first.conc)?first.conc:'0';
      body.resultado = String(val);
    }

    payloads.push({
      documento,
      idProcedimientoObjetivo: examId,
      body,
      indices: groupData.indices 
    });
  }
  return payloads;
}

/* ====== Send to API ====== */
async function sendToArmarJson(payload) {
  if (!_TOKEN) throw new Error('No hay token. Inicia sesi√≥n primero.');
  const url = `${API_BASE}?token=${encodeURIComponent(_TOKEN)}&documento=${encodeURIComponent(payload.documento)}&idProcedimientoObjetivo=${encodeURIComponent(payload.idProcedimientoObjetivo)}&idUsuario=${encodeURIComponent(payload.body.idUsuario)}`;
  
  let res, text;
  try {
    res = await fetch(url, { method:'POST', headers:{ 'Content-Type':'application/json' }, body: JSON.stringify(payload.body) });
    text = await res.text();
  } catch (error) {
    return { ok: false, text: `Error de red: ${error.message}` };
  }
  
  // Extraer solo el mensaje
  const message = extractMessageFromResponse(text);
  
  return { ok: res.ok, text: message };
}

function getFilteredRowsForSend() {
  const filter = normalize(document.getElementById('filterInput').value);
  const onlyMapped = document.getElementById('mappedOnly').checked;
  return lastRows.filter(r => {
    if (!r.id_examen) return false;
    if (onlyMapped && !r.id_examen) return false;
    if (filter) {
      const f = filter;
      if (!(r.paciente.includes(f) || normalize(r.prueba).includes(f) || (r.id_examen && r.id_examen.includes(f)))) return false;
    }
    return true;
  });
}

// Env√≠o a la API

document.getElementById('sendApi').addEventListener('click', async () => {
  const idUsuario = document.getElementById('idUsuario').value.trim();
  if (!idUsuario) return alert('Ingresa el idUsuario antes de subir a la API');
  if (!lastRows.length) return alert('Primero parsea el archivo TXT');
  if (!_TOKEN) return alert('Debes iniciar sesi√≥n para obtener token antes de enviar');

  const rowsToSend = getFilteredRowsForSend();
  if (!rowsToSend.length) return alert('No hay filas con ID_EXAMEN para enviar');

  const payloads = buildApiPayloads(rowsToSend, idUsuario);
  if (!payloads.length) return alert('No hay payloads v√°lidos');

  if (!confirm(`Se enviar√°n ${payloads.length} peticiones a la API.\n¬øContinuar?`)) return;

  /* ===== UI PROGRESO ===== */
  const progressBox = document.getElementById('uploadProgress');
  const progressBar = document.getElementById('progressBar');
  const progressText = document.getElementById('progressText');
  const okCountEl = document.getElementById('okCount');
  const failCountEl = document.getElementById('failCount');

  progressBox.classList.remove('hidden');
  progressBar.style.width = '0%';

  let total = payloads.length;
  let sent = 0;
  let ok = 0;
  let fail = 0;

  okCountEl.textContent = '0';
  failCountEl.textContent = '0';
  progressText.textContent = `0 / ${total}`;

  /* Marcar filas como enviando */
  rowsToSend.forEach(r => {
    r.apiMessage = 'Enviando‚Ä¶';
    r.rowClass = 'row-sending';
  });
  render(lastRows);

  for (const p of payloads) {
    try {
      const result = await sendToArmarJson(p);
      sent++;

      const matchingRows = lastRows.filter(r =>
        r.paciente === p.documento &&
        r.id_examen === p.idProcedimientoObjetivo
      );

      if (result.ok) {
        ok++;
        matchingRows.forEach(r => {
          r.apiMessage = `‚úÖ ${result.text}`;
          r.rowClass = 'row-success';
        });
      } else {
        fail++;
        matchingRows.forEach(r => {
          r.apiMessage = `‚ùå ${result.text}`;
          r.rowClass = 'row-error';
        });
      }

    } catch (err) {
      sent++;
      fail++;
      lastRows
        .filter(r =>
          r.paciente === p.documento &&
          r.id_examen === p.idProcedimientoObjetivo
        )
        .forEach(r => {
          r.apiMessage = `‚ùå Error de red`;
          r.rowClass = 'row-error';
        });
    }

    /* ===== ACTUALIZAR BARRA ===== */
    const percent = Math.round((sent / total) * 100);
    progressBar.style.width = percent + '%';
    progressText.textContent = `${sent} / ${total}`;
    okCountEl.textContent = ok;
    failCountEl.textContent = fail;

    render(lastRows);
  }

  alert(`Proceso terminado.\n‚úî √âxitos: ${ok}\n‚ùå Errores: ${fail}`);
});





// Inicializar UI
renderAuth();



  </script>
</body>
</html>